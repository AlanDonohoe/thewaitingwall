<script src="//js.pusher.com/2.2/pusher.min.js" type="text/javascript"></script>

<script type="text/javascript">
  <% unless Rails.env.production? %>
  // Enable pusher logging - don't include this in production
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.log(message);
      }
    };
  <% end %>
  var pusher = new Pusher('<%= Pusher.key %>', {
    cluster: 'eu'
  });
  var channel = pusher.subscribe('the_waiting_wall');
  channel.bind('wall_update', function(data) {

    <% if @public_view %>
     $.ajax({url: '/thewall?public_view=true', dataType: 'script'});
    <% elsif Tenant.append_guest_url?(current_tenant.subdomain) %>
      $.ajax({url: "<%= append_current_tenant_subdomain_url('/thewall') %>", dataType: 'script'});
    <% else %>
      $.ajax({url: '/thewall', dataType: 'script'});
    <% end %>
    
  });
  <% unless Rails.env.production? %>
  // Some useful debug msgs
  pusher.connection.bind('connecting', function() {
    console.log('Connecting to Pusher...');
  });
  pusher.connection.bind('connected', function() {
    console.log('Connected to Pusher!');
  });
  pusher.connection.bind('failed', function() {
    console.log('Connection to Pusher failed :(');
  });
  channel.bind('subscription_error', function(status) {
    console.log('Pusher subscription_error');
  });
  <% end %>
</script>